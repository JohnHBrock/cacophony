<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cacophony Node View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Don Patterson">
    <link rel="shortcut icon" href="/favicon.ico" />
    
    <link href="/lib/css/bootstrap.min.css" rel="stylesheet">
    <style>
		body {
			padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
		}

body {
  font: 10px sans-serif;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.dot {
  fill: white;
  stroke: steelblue;
  stroke-width: 1.5px;
}
      
	

    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>

	<div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#"><i class="icon-time" id="namespaceStatus"></i><span id="namespace"></span></a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span3">
				<h3>Current Server:</h3>
				<a class="btn disabled" id="currentServer" href="#"><i class="icon-time" id="currentServerStatus"></i></a>
			</div>
			<div class="span2">
				<h3>ID:</h3>
				<a class="btn disabled" id="currentID" href="#"><i class="icon-time" id="currentIDStatus"></i></a>
			</div>
			<div class="span3">
				<h3>Name:</h3>
				<a class="btn disabled" id="currentName" href="#"><i class="icon-time" id="currentNameStatus"></i></a>
			</div>
			<div class="span4">
				<h3>Directory Servers:</h3>
				<div id="serverList">
				</div>
			</div>
		</div>
	</div>
	
	<div class="container-fluid">
		<div id="nodeProgressBarContainer">
			<div class="row-fluid">
				<div class="span12">
					<div class="progress progress-striped active">
						<div id="nodeProgressBar" class="bar" style="float:left;width:0%"></div>
					</div>
				</div>
			</div>
		</div>
    </div>
    
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
				<div id="chart">
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span1">
			</div>
			<div class="span11">
				<div class="btn-group" data-toggle="buttons-checkbox">
					<button class="btn btn-mini btn-primary day-btn" id="day-btn-sunday">Sunday</button>

					<button class="btn btn-mini btn-success day-btn" id="day-btn-monday">Monday</button>
					<button class="btn btn-mini btn-warning day-btn" id="day-btn-tuesday">Tuesday</button>
					<button class="btn btn-mini btn-important day-btn" id="day-btn-wednesday">Wednesday</button>
					<button class="btn btn-mini btn-info day-btn" id="day-btn-thursday">Thursday</button>
					<button class="btn btn-mini btn-inverse day-btn" id="day-btn-friday">Friday</button>
					<button class="btn btn-mini btn-danger day-btn" id="day-btn-saturday">Saturday</button>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span1">
				<button class="btn btn-mini btn-info"><i class="icon-chevron-left"></i></button>
			</div>
			<div class="span10">
			</div>
			<div class="span1">
				<button class="btn btn-mini btn-info"><i class="icon-chevron-right"></i></button>
			</div>
		</div>
	</div>

     <!-- /container -->

    <!-- ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!--<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script> -->
	<script src="/lib/orig/bootstrap/docs/assets/js/jquery.js"></script>
    
    <script src="/lib/js/bootstrap.min.js"></script>
    
    <script src="/lib/js/d3.v2.min.js"></script>

	
	<script>
		var myAPIVersion = "1.2";
		var myServerList = null;
		var myServerListCallBusy = false;
		
		function myIconChange(selector,oldIcon,newIcon){
				$(selector).animate({opacity:0.0},500,function(){
					$(selector).removeClass(oldIcon);
					$(selector).addClass(newIcon);
					$(selector).animate({opacity:1.0},500);
				})
		};

		function updateNamespace(){
			var myNamespace = unescape(getURLParameter("namespace"));
			if(myNamespace != null){
				myIconChange('#namespaceStatus','icon-time','icon-ok');
				$('#namespaceStatus').html(myNamespace);
			}
			else{
				myIconChange('#currentServerStatus','icon-time','icon-remove');
			}
		}


		function updateCurrentLocation(){
			var myLocation = "http://"+window.location.host+"/index.html";
			if(location != null){
				myIconChange('#currentServerStatus','icon-time','icon-ok');
				$('#currentServer').attr('href',myLocation);
				$('#currentServer').tooltip({title:myLocation,placement:'bottom'});
				$('#currentServer').removeClass('disabled');
				$('#currentServer').append(' '+window.location.host);
			}
			else{
				myIconChange('#currentServerStatus','icon-time','icon-remove');
			}
		}

		function updateID(){
			var myNode = getURLParameter("node");
			if(myNode != null){
				myIconChange('#currentIDStatus','icon-time','icon-ok');
				$('#currentID').removeClass('disabled');
				$('#currentID').append(' '+myNode);
			}
			else{
				myIconChange('#currentServerStatus','icon-time','icon-remove');
			}
		}
		
		
		function updateName(){
			var myName = unescape(getURLParameter("name"));
			if(myName != null){
				myIconChange('#currentNameStatus','icon-time','icon-ok');
				$('#currentName').removeClass('disabled');
				$('#currentName').append(' '+myName);
			}
			else{
				myIconChange('#currentServerStatus','icon-time','icon-remove');
			}
		}
		
		
		function updateMyServerList(){
			$('#serverList').animate({opacity:0.0},500,function(){
				$('#serverList').html('');
				var myIndex=0;
				i= document.referrer;
				$('#serverList').append('<a class="btn disabled" id="altServer'+myIndex+'" href="'+i+'"><i class="icon-time" id="altServer'+myIndex+'Status"></i> '+i+'</a>');
				myIconChange('#altServer'+myIndex+'Status','icon-time','icon-ok');
				$('#altServer'+myIndex).removeClass('disabled');
				$('#serverList').animate({opacity:1.0},500);
			});
		}

		function setProgressBar(newWidth){
			$('#nodeProgressBar').css('width',(newWidth)+'%');
			$('#nodeProgressBar').text((newWidth)+'%')

		}
		
		function getURLParameter(name) {
			return decodeURI((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]);
		}

		var predictionData = null;
	
		function getPredictionData(){
			var myNode = getURLParameter("node");
			$.ajax({
				url:'/predict',
				dataType:'jsonp',
				data:{version:myAPIVersion,node:myNode},
				timeout : 60000,
				success:function(data){
					setProgressBar(100);
					$('#nodeProgressBarContainer').animate({opacity:0.0},500,function(){
						$('#nodeProgressBarContainer').html("");
					});
					
					if(data.error == "true"){
						alert(data.errors[0]);
					}
					else{
						predictionData = data;
						
						var i;
						predictionData.sunday[0]['lineStroke']="#08C";
						for(i=0; i < predictionData.sunday.length; i++){
							predictionData.sunday[i].circleStroke="#05C";
						}
						predictionData.monday[0].lineStroke="#62C462";
						for(i=0; i < predictionData.monday.length; i++){
							predictionData.monday[i].circleStroke="#51A351";
						}
						predictionData.tuesday[0].lineStroke="#FBB450";
						for(i=0; i < predictionData.tuesday.length; i++){
							predictionData.tuesday[i].circleStroke="#F89406";
						}
						predictionData.wednesday[0].lineStroke="#BBBBBB";
						for(i=0; i < predictionData.wednesday.length; i++){
							predictionData.wednesday[i].circleStroke="#999999";
						}
						predictionData.thursday[0].lineStroke="#5BC0DE";
						for(i=0; i < predictionData.thursday.length; i++){
							predictionData.thursday[i].circleStroke="#2F96B4";
						}
						predictionData.friday[0].lineStroke="#444444";
						for(i=0; i < predictionData.friday.length; i++){
							predictionData.friday[i].circleStroke="#222222";
						}
						predictionData.saturday[0].lineStroke="#EE5F5B";
						for(i=0; i < predictionData.saturday.length; i++){
							predictionData.saturday[i].circleStroke="#BD362F";
						}
						
						initializeGraph();
					}
				},
				error:function(){
					alert("Unable to load data");
				}
			});
		}
		
		function initializeGraph(){
		
			var myCircles = [];
			var myLines = [];
			var d = new Date();
			var n = d.getDay();
			if(n == 0){
				$('#day-btn-sunday').removeClass('inactive');
				$('#day-btn-sunday').addClass('active');
				myCircles = myCircles.concat(predictionData.sunday);
				myLines.push(predictionData.sunday);
			}
			if(n == 1){
				$('#day-btn-monday').removeClass('inactive');
				$('#day-btn-monday').addClass('active');
				myCircles = myCircles.concat(predictionData.monday);
				myLines.push(predictionData.monday);
			}
			if(n == 2){
				$('#day-btn-tuesday').removeClass('inactive');
				$('#day-btn-tuesday').addClass('active');
				myCircles = myCircles.concat(predictionData.tuesday);
				myLines.push(predictionData.tuesday);
			}
			if(n == 3){
				$('#day-btn-wednesday').removeClass('inactive');
				$('#day-btn-wednesday').addClass('active');
				myCircles = myCircles.concat(predictionData.wednesday);
				myLines.push(predictionData.wednesday);
			}
			if(n == 4){
				$('#day-btn-thursday').removeClass('inactive');
				$('#day-btn-thursday').addClass('active');
				myCircles = myCircles.concat(predictionData.thursday);
				myLines.push(predictionData.thursday);
			}
			if(n == 5){
				$('#day-btn-friday').removeClass('inactive');
				$('#day-btn-friday').addClass('active');
				myCircles = myCircles.concat(predictionData.friday);
				myLines.push(predictionData.friday);
			}
			if(n == 6){
				$('#day-btn-saturday').removeClass('inactive');
				$('#day-btn-saturday').addClass('active');
				myCircles = myCircles.concat(predictionData.saturday);
				myLines.push(predictionData.saturday);
			}
			drawGraph(myCircles,myLines);
		}
		
		/*
			predictionData = {
			sunday:[{x:780,y:1.0},
			{x:790,y:0.9},
			{x:800,y:0.8},
			{x:810,y:0.7},
			{x:820,y:0.6},
			{x:830,y:0.5},
			{x:1190,y:0.4}],
			monday:[{x:780,y:0.0},
			{x:790,y:0.1},
			{x:800,y:0.2},
			{x:810,y:0.3},
			{x:820,y:0.4},
			{x:830,y:0.5},
			{x:840,y:0.5},
			{x:850,y:0.5},
			{x:1200,y:0.6}],
			tuesday:[{x:780,y:0.0},
			{x:790,y:0.1},
			{x:800,y:0.2},
			{x:810,y:0.2},
			{x:820,y:0.2},
			{x:830,y:0.2},
			{x:840,y:0.3},
			{x:850,y:0.3},
			{x:1210,y:0.3}],
			wednesday:[{x:780,y:0.0},
			{x:790,y:0.2},
			{x:800,y:0.2},
			{x:810,y:0.4},
			{x:820,y:0.4},
			{x:830,y:0.4},
			{x:840,y:0.4},
			{x:850,y:0.4},
			{x:1220,y:0.4}],
			thursday:[{x:780,y:0.0},
			{x:790,y:0.9},
			{x:800,y:0.9},
			{x:810,y:0.7},
			{x:820,y:0.5},
			{x:830,y:0.5},
			{x:840,y:0.5},
			{x:850,y:0.5},
			{x:1230,y:0.6}],
			friday:[{x:780,y:0.0},
			{x:790,y:0.8},
			{x:800,y:0.8},
			{x:810,y:0.6},
			{x:820,y:0.6},
			{x:830,y:0.6},
			{x:840,y:0.6},
			{x:850,y:0.6},
			{x:1240,y:0.8}],
			saturday:[{x:780,y:0.0},
			{x:790,y:0.5},
			{x:800,y:0.9},
			{x:810,y:0.8},
			{x:820,y:0.9},
			{x:830,y:0.8},
			{x:840,y:0.9},
			{x:850,y:0.8},
			{x:1250,y:0.9}],
			};
			*/



var margin = {top: 10, right: 10, bottom: 20, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .domain([780, 1260])
    .range([780, 1260]);

var y = d3.scale.linear()
    .domain([0, 60])
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line = d3.svg.line()
    .x(function(d) { return x(d.x-780); })
    .y(function(d) { return y(d.y); })
	.interpolate("cardinal");

var lineStrokeSelector = function(d,i){return ""+d[0].lineStroke;};
var circleStrokeSelector = function(d,i){return ""+d.circleStroke;};

var vis = d3.select("#chart")
	.style('margin','20px auto')
	.style('width','#'+width+'px')
	.append("svg:svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.append("svg:g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

vis.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(-780," + height + ")")
    .call(xAxis);

vis.append("g")
    .attr("class", "y axis")
    .call(yAxis);

vis.append("g")
	.attr("class","myLines");

vis.append("g")
	.attr("class","myDots");



	function drawGraph(myCircles,myLines){

		vis.selectAll("path.line").remove();
		vis.selectAll(".dot").remove();


		vis.selectAll(".line")
			.data(myLines)
			.enter()
			.append("svg:path")
			.style("stroke", lineStrokeSelector)
			.attr("class","line")
			.attr("d",line);

		vis.selectAll(".dot")
			.data(myCircles)
			.enter()
			.append("circle")
			.style("stroke", circleStrokeSelector)
			.attr("class", "dot")
			.attr("cx", line.x())
			.attr("cy", line.y())
			.attr("r", 3.5);

	}


	$('.day-btn').bind('click',function(event){

		var myCircles = [];
		var myLines = [];
		var butt = $(this).attr('id');


		if (butt == 'day-btn-sunday'){
			if(! $('#day-btn-sunday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.sunday);
				myLines.push(predictionData.sunday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-sunday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.sunday);
				myLines.push(predictionData.sunday);
			}
		}

		if (butt == 'day-btn-monday'){
			if(! $('#day-btn-monday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.monday);
				myLines.push(predictionData.monday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-monday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.monday);
				myLines.push(predictionData.monday);
			}
		}

		if (butt == 'day-btn-tuesday'){
			if(! $('#day-btn-tuesday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.tuesday);
				myLines.push(predictionData.tuesday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-tuesday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.tuesday);
				myLines.push(predictionData.tuesday);
			}
		}


		if (butt == 'day-btn-wednesday'){
			if(! $('#day-btn-wednesday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.wednesday);
				myLines.push(predictionData.wednesday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-wednesday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.wednesday);
				myLines.push(predictionData.wednesday);
			}
		}


		if (butt == 'day-btn-thursday'){
			if(! $('#day-btn-thursday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.thursday);
				myLines.push(predictionData.thursday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-thursday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.thursday);
				myLines.push(predictionData.thursday);
			}
		}


		if (butt == 'day-btn-friday'){
			if(! $('#day-btn-friday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.friday);
				myLines.push(predictionData.friday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-friday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.friday);
				myLines.push(predictionData.friday);
			}
		}


		if (butt == 'day-btn-saturday'){
			if(! $('#day-btn-saturday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.saturday);
				myLines.push(predictionData.saturday);
			}
			else{
			}
		}
		else{
			if($('#day-btn-saturday').hasClass('active')){
				myCircles = myCircles.concat(predictionData.saturday);
				myLines.push(predictionData.saturday);
			}
		}

		drawGraph(myCircles,myLines);


		});

		
		
		$(document).ready(function(){

			setProgressBar(1);
			updateNamespace();

			setProgressBar(2);
			updateCurrentLocation();

			setProgressBar(3);
			updateID();
			
			setProgressBar(4);
			updateName();

			setProgressBar(5);
			updateMyServerList();

			setProgressBar(10);
			getPredictionData();

			setProgressBar(11);
			var currentBar = 11;
			var progress = setInterval(function() {
				if (currentBar >= 99) {
					clearInterval(progress);
				} else {
					currentBar += 1;
					setProgressBar(currentBar);
				}
			}, 700);
			
		});
	</script>

  </body>
</html>

