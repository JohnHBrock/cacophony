<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cacophony Directory Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Don Patterson">
    <link rel="shortcut icon" href="/favicon.ico" />
    

    <link href="/lib/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/css/datatables/demo_table.css" rel="stylesheet">
    <style>
		body {
			padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
		}
      
		#health-chart {
			background-color: #ffffff;
			border: 0px solid gray;
			font: 10px sans-serif;
			text-shadow: none;
		}
		
		#health-chart .total{
			font-size: 18px;
			font-weight: bold;
		}
		
		#health-chart .units{
			fill: gray;
			font-size: 12px;
		}
		
		#health-chart .label{
			fill: #CCC;
			font-size: 12px;
			font-weight: bold;
		}
		
		#health-chart .value{
			font-size: 12px;
			font-weight: bold;
		}â€‹
		
	
	

    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>

	<div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#"><i class="icon-time" id="namespaceStatus"></i><span id="namespace"></span></a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span4">
				<h3>Current Server:</h3>
				<a class="btn disabled" id="currentServer" href="#"><i class="icon-time" id="currentServerStatus"></i></a>
			</div>
			<div class="span8">
				<h3>Alternative Servers:</h3>
				<div id="serverList">
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span4">
				<h3>Summary</h3>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 offset3">
				<div id="health-chart">
				</div>
			</div>
			<div class="span4">
			<div style="padding-top:30px">
			<table class="table table-bordered">
				<thead>
					<tr>
					<th>
						<h3>Category</h3>
					</th>
					<th>
						<h3>Count</h3>
					</th>
					</tr>
				</thead>
				<tbody>
				<tr>
					<td>
						<h4>Healthy</h4>	
					</td>
					<td>
						<span class="badge badge-success" id="health-table-healthy">
							?	
						</span>
					</td>
				</tr>
				<tr>
					<td>
						<h4>Faltering</h4>
					</td>
					<td>
						<span class="badge badge-warning" id="health-table-faltering">
							?	
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<h4>Stale</h4>
					</td>
					<td>
						<span class="badge badge-important" id="health-table-stale">
							?	
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<h4>Unknown</h4>
					</td>
					<td>
						<span class="badge badge-default" id="health-table-unknown">
							?	
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<h4>Unassigned</h4>
					</td>
					<td>
						<span class="badge badge-info" id="health-table-unassigned">
							?	
						</div>
					</td>
				</tr>
				</tbody>
			</table>
			</div>
			</div>
		</div>
	</div>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span4">
			<h3>Cacophony Node List</h3>
			</div>
		</div>
		<div id="nodeProgressBarContainer">
		<div class="row-fluid">
			<div class="span12">
			<div class="progress progress-striped active">
				<div id="nodeProgressBar" class="bar" style="float:left;width:0%"></div>
			</div>
			</div>
		</div>
		</div>
		<div class="row-fluid">
			<div class="span12">
				<div class="tabbable"> 
  					<ul class="nav nav-tabs">
						<li><a href="#tab1" data-toggle="tab">List View</a></li>
						<li class="active"><a href="#tab2" data-toggle="tab">Map View</a></li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane" id="tab1">
							<div id="nodeList">
							</div>
						</div>
						<div class="tab-pane active" id="tab2">
							<div id="nodeMap" style="height: 600px; width:100%;">
							</div>
							
    					</div>
    				</div>
				</div>
			</div>
		</div>

    </div> <!-- /container -->

    <!-- ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    
    <script src="/lib/js/bootstrap.min.js"></script>
    
    <script src="/lib/js/jquery.dataTables.min.js"></script>
    <script src="/lib/js/d3.v2.min.js"></script>

	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=visualization"></script>
	
	
	<script>
		var myNamespace = null;
		var myServerList = null;
		var myServerListCallBusy = false;
		var myNodeList = null;
		var myNodeListCallBusy = 0;
		
		var myNodeMonitorQueue = [];
		var myNodeMonitorBusy = 0;
		
		function addNodeToNodeMonitor(myID, counter){
			if((counter == undefined) || (counter == null)){
				counter = { healthy:0,faltering:0,stale:0,unassigned:1,unknown:0};
			}
			
			var myData = {id: myID,
						  status: counter};
			myNodeMonitorQueue.push(myData);
		}
		
		
		function calculateStatusDetails(node){
			var counter = { healthy:0,faltering:0,stale:0,unassigned:0,unknown:0,new_html:""};
			if(node.c_node_references != undefined){
				$('#nodeRefreshData_'+escape(node.id)).html('');
				$.each(node.c_node_references,function(k,v){
					if(v.last_heartbeat != undefined){
						var d = new Date();
						if(v.last_heartbeat > (d.getTime() - 10*60*1000)){
							counter.new_html = counter.new_html + '<span class="badge badge-success"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-thumbs-up icon-white" rel="tooltip" title="Healthy"></i></a></span>';
							//$('#nodeRefreshData_'+escape(node.id)).append('<span class="badge badge-success"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-thumbs-up icon-white" rel="tooltip" title="Healthy"></i></a></span>');
							counter.healthy++;
						}
						else if(v.last_heartbeat > (d.getTime() - 30*60*1000)){
							counter.new_html = counter.new_html + '<span class="badge badge-warning"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-hand-left icon-white" rel="tooltip" title="Faltering"></i></a></span>';
							//$('#nodeRefreshData_'+escape(node.id)).append('<span class="badge badge-warning"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-hand-left icon-white" rel="tooltip" title="Faltering"></i></a></span>');
							counter.faltering++;
						}
						else{
							counter.new_html = counter.new_html + '<span class="badge badge-important"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-thumbs-down icon-white" rel="tooltip" title="Stale"></i></a></span>';
							//$('#nodeRefreshData_'+escape(node.id)).append('<span class="badge badge-important"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-thumbs-down icon-white" rel="tooltip" title="Stale"></i></a></span>');
							counter.stale++;
						}
					}
					else{
						counter.new_html = counter.new_html + '<span class="badge badge-default"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-question-sign icon-white" rel="tooltip" title="Unknown"></i></a></span>';
						//$('#nodeRefreshData_'+escape(node.id)).append('<span class="badge badge-default"><a href="http://'+v.access_routes_for_ui[0].route+'"><i class="icon-question-sign icon-white" rel="tooltip" title="Unknown"></i></a></span>');
						counter.unknown++;
					}
				});
			}
			else{
				counter.unassigned++;
			}
			
			var normalize = counter.healthy + counter.faltering + counter.stale + counter.unassigned + counter.unknown;
			if(normalize == 0){
				counter.unknown = 1;
			}
			else{
				counter.healthy /= normalize;
				counter.faltering /= normalize;
				counter.stale /= normalize;
				counter.unassigned /= normalize;
				counter.unknown /= normalize;
			}
			return counter;
		}
		
		function calculateStatusHealth(counter){
			return(counter.healthy*1000.0 + counter.faltering*100.0 + counter.stale * 10.0 + counter.unassigned)
		}
		
		function calculateStatusDetailsAndUpdateHTML(node){
			var counter = calculateStatusDetails(node);
			var health = calculateStatusHealth(counter);
			$('#nodeHealthData_'+escape(node.id)).replaceWith(health+'<div id="#nodeHealthData_'+escape(node.id)+'"></div>');
			$('#nodeRefreshData_'+escape(node.id)).html(counter.new_html);
			return counter;
		}
								
		
		function runNodeMonitor(){
			if(myNodeMonitorBusy > 0){
				return;
			}
			if(myNodeMonitorQueue.length == 0 ){
				return;
			}
				
			myNodeMonitorBusy++;
			
			var next = myNodeMonitorQueue.shift();
			var myGuids = [next.id];
			var myData = {version:"1.1",namespace:myNamespace,guids:JSON.stringify(myGuids)};
			myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-remove','icon-time');
			myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-ok','icon-time');
			$.ajax({
				url:'/nodes',
				dataType:'jsonp',
				data:myData,
				timeout : 90000,
				success:function(data){
					$('#nodeRefreshData_'+escape(next.id)).html("");
					myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-time','icon-ok');
					myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-remove','icon-ok');
					if(data.nodes != undefined){
						$.each(data.nodes,function(k,v){
							counter = calculateStatusDetailsAndUpdateHTML(v);
							counter.new_html =""; //Save space
							next.status = counter;
						});
					}
					
					myNodeMonitorQueue.push(next);
					myNodeMonitorBusy--;
				},
				error:function(){
					myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-time','icon-remove');
					myIconChange('#nodeRefreshStatus_'+escape(next.id),'icon-ok','icon-remove');
					myNodeMonitorBusy--;
				}
			});
		};
		
		function updateNodeStatusFromButton(escapedID){
			myNodeMonitorBusy++;
			var myID = escapedID;
			myIconChange('#nodeRefreshStatus_'+myID,'icon-ok','icon-question-sign');
			myIconChange('#nodeRefreshStatus_'+myID,'icon-time','icon-question-sign');
			var myGuids = [myID];
			var myData = {version:"1.1",namespace:myNamespace,guids:JSON.stringify(myGuids)};
			$.ajax({
				url:'/nodes',
				dataType:'jsonp',
				data:myData,
				timeout : 90000,
				success:function(data){
					$('#nodeRefreshData_'+myID).html("");
					myIconChange('#nodeRefreshStatus_'+myID,'icon-question-sign','icon-ok');
					if(data.nodes != undefined){
						$.each(data.nodes,function(k,v){
							calculateStatusDetailsAndUpdateHTML(v);
						});
					}
					myNodeMonitorBusy--;
				},
				error:function(){
					myIconChange('#nodeRefreshStatus_'+myID,'icon-question-sign','icon-remove');
					myNodeMonitorBusy--;
				}
			});
		};

		function myIconChange(selector,oldIcon,newIcon){
				$(selector).animate({opacity:0.0},500,function(){
					$(selector).removeClass(oldIcon);
					$(selector).addClass(newIcon);
					$(selector).animate({opacity:1.0},500);
				})
		};

		function updateNamespace(){
			$.ajax({
				url:'/namespace',
				dataType:'jsonp',
				data:{version:"1.1"},
				timeout : 15000,
				success:function(data){
					myIconChange('#namespaceStatus','icon-time','icon-ok');
					$('#namespace').html(data.namespace);
					myNamespace = data.namespace;
				},
				error:function(){
					myIconChange('#namespaceStatus','icon-time','icon-remove');
					$('#namespace').html('Unknown namespace');
				}
			});
		}


		function updateCurrentLocation(){
			var myLocation = "http://"+window.location.host+"/index.html";
			if(location != null){
				myIconChange('#currentServerStatus','icon-time','icon-ok');
				$('#currentServer').attr('href',myLocation);
				$('#currentServer').tooltip({title:myLocation,placement:'bottom'});
				$('#currentServer').removeClass('disabled');
				$('#currentServer').append(' '+window.location.host);
			}
			else{
				myIconChange('#currentServerStatus','icon-time','icon-remove');
			}
		}

		function checkDirectoryServer(i,ip){

			$.ajax({
				url:'http://'+ip+'/version',
				dataType:'jsonp',
				data:{version:"1.1",namespace:myNamespace},
				timeout : 15000,
				success:function(data){
					if(data.version != undefined){
						myIconChange('#altServer'+i+'Status','icon-time','icon-ok');
						$('#altServer'+i).removeClass('disabled');
					}
					else{
						myIconChange('#altServer'+i+'Status','icon-time','icon-remove');
					}
				},
				error:function(){
					myIconChange('#altServer'+i+'Status','icon-time','icon-remove');
				}
			});
		}

		function updateMyServerList(){
			$('#serverList').animate({opacity:0.0},500,function(){
				$('#serverList').html('');
				var myIndex=0;
				$.each(myServerList.servers,function(k,v){
					if(v.access_routes != undefined){
						$.each(v.access_routes,function(kk,vv){
							i=vv.url;
							$('#serverList').append('<a class="btn disabled" id="altServer'+myIndex+'" href="http://'+i+'/index.html"><i class="icon-time" id="altServer'+myIndex+'Status"></i> '+i+'</a>');
							checkDirectoryServer(myIndex,i);
							myIndex=myIndex+1;
						});
					}
				});
				$('#serverList').animate({opacity:1.0},500);
			});
		}

		function getMyServerList(){
			if(!myServerListCallBusy){
				myServerListCallBusy = true;

				$.ajax({
					url:'/servers',
					dataType:'jsonp',
					data:{version:"1.1",namespace:myNamespace},
					timeout : 10000,
					success:function(data){
						if(JSON.stringify(data) != JSON.stringify(myServerList)){
							myServerList=data;
							updateMyServerList();
						}
						myServerListCallBusy=false;
					},
					error:function(data){
						myServerListCallBusy=false;
					}
				});
			}
		};


		function updateMyNodeList(){
			$('#nodeList').animate({opacity:0.0},500,function(){
				$('#nodeList').html('<table id="myNodeListTable"></table>');

				//Build the table
				var aaData =[];
				$.each(myNodeList.nodes,function(k,v){
					var line = [];
					line.push('<a class="btn" id="nodeRefresh'+escape(v.id)+'" onClick="updateNodeStatusFromButton(\''+escape(v.id)+'\')"><i class="icon-time" id="nodeRefreshStatus_'+escape(v.id)+'"></i> </a>');
					line.push(v.id);
					if(v.name != undefined){
						line.push(v.name);
					}
					else{
						line.push('');
					}
					if(v.latitude != undefined){
						line.push(v.latitude);
					}
					else{
						line.push('');
					}
					if(v.longitude != undefined){
						line.push(v.longitude);
					}
					else{
						line.push('');
					}
					var counter = calculateStatusDetails(v);
					var health = calculateStatusHealth(counter);
					line.push('<div id="nodeHealthData_'+escape(v.id)+'">'+health+'</div>');
					line.push('Hits');
					line.push('<div id="nodeRefreshData_'+escape(v.id)+'">'+counter.new_html+'</div>');
					aaData.push(line);
				});
				
				var myTable;
				$('#nodeList').animate({opacity:1.0},500,function(){
					myTable = $('#myNodeListTable').dataTable({
						"sPaginationType": "full_numbers",
						"aaData": aaData,
						"aoColumns":[
							{"sTitle":"Refresh","sType":"html","sWidth":'30px',"sClass":"tableCell"},
							{"sTitle":"ID","sType":"numeric","sWidth":'60px',"sClass":"tableCell"},
							{"sTitle":"Name","sType":"string","sWidth":'200px',"sClass":"tableCell"},
							{"sTitle":"Latitude","sType":"numeric","sWidth":'60px',"sClass":"tableCell"},
							{"sTitle":"Longitude","sType":"numeric","sWidth":'60px',"sClass":"tableCell"},
							{"sTitle":"Health","sSortDataType":"dom-text","sType":'html',"sWidth":'60px',"sClass":"tableCell"},
							{"sTitle":"Hits","sType":"html","sWidth":'60px',"sClass":"tableCell"},
							{"sTitle":"Nodes","sType":"html","sWidth":'100px',"sClass":"tableCell"}
							]
					});
					//myTable.fnAdjustColumnSizing();
					//Populate the status
					$.each(myNodeList.nodes,function(k,v){
						var counter = calculateStatusDetailsAndUpdateHTML(v);
						counter.new_html =""; //Save space
						addNodeToNodeMonitor(v.id,counter);
					});
				});
				
				
				
			});
		}


		



		function updateMyNodeMap(){
			$('#nodeMap').animate({opacity:0.0},500,function(){
				var myIndex=0;
				var heatMapData = [];

				$.each(myNodeList.nodes,function(k,v){
					var map_weight = v.map_weight;
					if(map_weight != undefined){
						var longitude = v.longitude;
						if(longitude != undefined){
							var latitude = v.latitude;
							if(latitude != undefined){
								var point = {'location': new google.maps.LatLng(latitude, longitude), 'weight': map_weight};
								if(myIndex < 100000){
									heatMapData.push(point);
									myIndex=myIndex+1;
								}
							}
						}
					}
					
				});
				var heatmap = new google.maps.visualization.HeatmapLayer({
					data: heatMapData,
					radius: 30
				});
				var myOptions = {
					zoom: 4,
					center: new google.maps.LatLng(39.8,-98.5),
					mapTypeId: google.maps.MapTypeId.HYBRID
				};
				map = new google.maps.Map(document.getElementById('nodeMap'), myOptions);
				heatmap.setMap(map);

				$('#nodeMap').animate({opacity:1.0},500,function(){
					$('#nodeProgressBarContainer').html("");
				});

			});

		}


		function getMyNodeList(){
			if(myNodeListCallBusy == 0){
				myNodeListCallBusy++;
				myNodeMonitorBusy++;

				$.ajax({
					url:'/nodes',
					dataType:'jsonp',
					data:{version:"1.1",namespace:myNamespace},
					timeout : 60000,
					success:function(data){
						myNodeList=data;
						updateMyNodeList();

						updateMyNodeMap();
						
						myNodeListCallBusy--;
						myNodeMonitorBusy--;
					},
					error:function(data){
						myNodeListCallBusy--;
						myNodeMonitorBusy--;
					}
				});
			}
		};

		function setProgressBar(newWidth){
			$('#nodeProgressBar').css('width',(newWidth)+'%');
			$('#nodeProgressBar').text((newWidth)+'%')

		}
		
		///////////////////////////////////////////////////////////
		// FUNCTIONS //////////////////////////////////////////////
		///////////////////////////////////////////////////////////

		// Interpolate the arcs in data space.
		function pieTween(d, i) {
			var s0;
			var e0;
			
			if(oldPieData[i]){
				s0 = oldPieData[i].startAngle;
				e0 = oldPieData[i].endAngle;
			} else if (!(oldPieData[i]) && oldPieData[i-1]) {
				s0 = oldPieData[i-1].endAngle;
				e0 = oldPieData[i-1].endAngle;
			} else if(!(oldPieData[i-1]) && oldPieData.length > 0){
				s0 = oldPieData[oldPieData.length-1].endAngle;
				e0 = oldPieData[oldPieData.length-1].endAngle;
			} else {
				s0 = 0;
				e0 = 0;
			}
			var i = d3.interpolate({startAngle: s0, endAngle: e0}, {startAngle: d.startAngle, endAngle: d.endAngle});
			return function(t) {
				var b = i(t);
				return arc(b);
			};
		}
			

		function removePieTween(d, i) {
			s0 = 2 * Math.PI;
			e0 = 2 * Math.PI;
			var i = d3.interpolate({startAngle: d.startAngle, endAngle: d.endAngle}, {startAngle: s0, endAngle: e0});
			return function(t) {
				var b = i(t);
				return arc(b);
			};
		}


		function textTween(d, i) {
			var a;
			if(oldPieData[i]){
				a = (oldPieData[i].startAngle + oldPieData[i].endAngle - Math.PI)/2;
			} else if (!(oldPieData[i]) && oldPieData[i-1]) {
				a = (oldPieData[i-1].startAngle + oldPieData[i-1].endAngle - Math.PI)/2;
			} else if(!(oldPieData[i-1]) && oldPieData.length > 0) {
				a = (oldPieData[oldPieData.length-1].startAngle + oldPieData[oldPieData.length-1].endAngle - Math.PI)/2;
			} else {
				a = 0;
			}
			var b = (d.startAngle + d.endAngle - Math.PI)/2;
			
			var fn = d3.interpolateNumber(a, b);
			return function(t) {
				var val = fn(t);
				return "translate(" + Math.cos(val) * (r+textOffset) + "," + Math.sin(val) * (r+textOffset) + ")";
			};
		}
		
		
		function updateHealthChart() {
			myNodeMonitorBusy++;
			var myPieDataHelper= {};
			var myPieData= [];
			if(myNodeMonitorQueue != undefined){
				$.each(myNodeMonitorQueue,function(k,v){
					$.each(v.status,function(k,v){
						if(myPieDataHelper[k] != undefined){
							if(myPieDataHelper[k].count != undefined){
								myPieDataHelper[k].count += v;
							}
							else{
								var foo ={ label:k, count:v}
								myPieDataHelper[k] = foo;
							}
						}
						else{
							var foo ={ label:k, count:v}
							myPieDataHelper[k] = foo;
						}
					});
				});
				$.each(myPieDataHelper,function(k,v){
					/*
					if(v.label == 'healthy'){
						v.count = 12010+Math.floor(Math.random()*100);
					}
					if(v.label == 'faltering'){
						v.count = 503+Math.floor(Math.random()*200);
					}
					if(v.label == 'stale'){
						v.count = 272+Math.floor(Math.random()*200);
					}
					if(v.label == 'unknown'){
						v.count = 334+Math.floor(Math.random()*200);
					}
					if(v.label == 'unassigned'){
						v.count = 20+Math.floor(Math.random()*10);
					}
					*/
					myPieData.push(v);
					$('#health-table-'+v.label).animate({opacity:0.0},500,function(){
						$('#health-table-'+v.label).html((v.count).toFixed(1));
						$('#health-table-'+v.label).animate({opacity:1.0},500);
					})
				});
			}
			myNodeMonitorBusy--;
			
			arraySize = myPieData.length;

			oldPieData = filteredPieData;
			pieData = donut(myPieData);

			var totalOctets = 0;
			filteredPieData = pieData.filter(filterData);
			function filterData(element, index, array) {
				element.name = myPieData[index].label;
				element.value = myPieData[index].count;
				totalOctets += element.value;
				return (element.value > 0);
			}

			if(filteredPieData.length > 0 && oldPieData.length > 0){
				//REMOVE PLACEHOLDER CIRCLE
				arc_group.selectAll("circle").remove();

				totalValue.text(function(){
					return (parseFloat(totalOctets)+0).toFixed(1);
				});

				//DRAW ARC PATHS
				paths = arc_group.selectAll("path").data(filteredPieData);
				paths.enter().append("svg:path")
					.attr("stroke", "white")
					.attr("stroke-width", 0.5)
					.attr("fill", function(d, i) { return color(d); })
					.transition()
					.duration(tweenDuration)
					.attrTween("d", pieTween);
				paths.transition()
					.duration(tweenDuration)
					.attrTween("d", pieTween);
				paths.exit()
					.transition()
					.duration(tweenDuration)
					.attrTween("d", removePieTween)
					.remove();

				//DRAW TICK MARK LINES FOR LABELS
				lines = label_group.selectAll("line").data(filteredPieData);
				lines.enter().append("svg:line")
					.attr("x1", 0)
					.attr("x2", 0)
					.attr("y1", -r-3)
					.attr("y2", -r-8)
					.attr("stroke", "gray")
					.attr("transform", function(d) {
						return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
					});
				lines.transition()
					.duration(tweenDuration)
					.attr("transform", function(d) {
						return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
					});
				lines.exit().remove();

				//DRAW LABELS WITH PERCENTAGE VALUES
				valueLabels = label_group.selectAll("text.value").data(filteredPieData)
					.attr("dy", function(d){
						if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
							return 5;
						} else {
							return -7;
						}
					})
					.attr("text-anchor", function(d){
						if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
							return "beginning";
						} else {
							return "end";
						}
					})
					.text(function(d){
						var percentage = (d.value/totalOctets)*100;
						return percentage.toFixed(1) + "%";
					});

				valueLabels.enter().append("svg:text")
					.attr("class", "value")
					.attr("transform", function(d) {
						return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
					})
					.attr("dy", function(d){
						if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
							return 5;
						} else {
							return -7;
						}
					})
					.attr("text-anchor", function(d){
						if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
							return "beginning";
						} else {
							return "end";
						}
					}).text(function(d){
						var percentage = (d.value/totalOctets)*100;
						return percentage.toFixed(1) + "%";
					});

				valueLabels.transition().duration(tweenDuration).attrTween("transform", textTween);

				valueLabels.exit().remove();


				//DRAW LABELS WITH ENTITY NAMES
				nameLabels = label_group.selectAll("text.units").data(filteredPieData)
					.attr("dy", function(d){
						if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
							return 17;
						} else {
							return 5;
						}
					})
					.attr("text-anchor", function(d){
						if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
							return "beginning";
						} else {
							return "end";
						}
					}).text(function(d){
						return d.name;
					});
	
				nameLabels.enter().append("svg:text")
					.attr("class", "units")
					.attr("transform", function(d) {
						return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
					})
					.attr("dy", function(d){
						if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
							return 17;
						} else {
							return 5;
						}
					})
					.attr("text-anchor", function(d){
						if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
	          				return "beginning";
						} else {
							return "end";
						}
					}).text(function(d){
						return d.name;
					});
	
				nameLabels.transition().duration(tweenDuration).attrTween("transform", textTween);
	
				nameLabels.exit().remove();
			}  
		}
							
					
				
		var w = 300;                        //width
		var h = 300;                        //height
		var r = 100;                        //radius
		var ir = 45;                        //inner radius
		var textOffset = 14;
		var tweenDuration = 250;
			
		var lines, valueLabels, nameLabels;
		var pieData = [];    
		var oldPieData = [];
		var filteredPieData = [];
		
		//D3 helper function to populate pie slice parameters from array data
		var donut = d3.layout.pie().value(function(d){
			return d.count;
		});
			
		var color = function(status){
					if(status.name == 'healthy') return '#468847';
					if(status.name == 'faltering') return '#f89406';
					if(status.name == 'stale') return '#b94a48';
					if(status.name == 'unknown') return '#999';
					if(status.name == 'unassigned') return '#3a87ad';
					return('#444444');
				};
					
			
		//D3 helper function to draw arcs, populates parameter "d" in path object
		var arc = d3.svg.arc()
					.startAngle(function(d){ return d.startAngle; })
					.endAngle(function(d){ return d.endAngle; })
					.innerRadius(ir)
					.outerRadius(r);
					
		var vis = d3.select("#health-chart").append("svg:svg")
					.attr("width", w)
					.attr("height", h);						
						
		//GROUP FOR ARCS/PATHS
		var arc_group = vis.append("svg:g")
						.attr("class", "arc")
						.attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");
						//GROUP FOR LABELS
							
		var label_group = vis.append("svg:g")
						.attr("class", "label_group")
						.attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");

		//GROUP FOR CENTER TEXT  
		var center_group = vis.append("svg:g")
						.attr("class", "center_group")
						.attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");

		//PLACEHOLDER GRAY CIRCLE
		var paths = arc_group.append("svg:circle")
						.attr("fill", "#EFEFEF")
						.attr("r", r);
						
		///////////////////////////////////////////////////////////
		// CENTER TEXT ////////////////////////////////////////////
		///////////////////////////////////////////////////////////

		//WHITE CIRCLE BEHIND LABELS
		var whiteCircle = center_group.append("svg:circle")
						.attr("fill", "white")
						.attr("r", ir);

		// "TOTAL" LABEL
		var totalLabel = center_group.append("svg:text")
						.attr("class", "label")
						.attr("dy", -15)
						.attr("text-anchor", "middle") // text-align: right
						.text("TOTAL");

		//TOTAL TRAFFIC VALUE			
		var totalValue = center_group.append("svg:text")
						.attr("class", "total")
						.attr("dy", 7)
						.attr("text-anchor", "middle") // text-align: right
						.text("Waiting...");

		//UNITS LABEL
		var totalUnits = center_group.append("svg:text")
						.attr("class", "units")
						.attr("dy", 21)
						.attr("text-anchor", "middle") // text-align: right
							.text("IDs");

		$(document).ready(function(){

			// Get namespace
			setProgressBar(1);
			updateNamespace();

			// Update current browser url info
			setProgressBar(2);
			updateCurrentLocation();

			// Start the generic progress bar
			setProgressBar(3);
			var currentBar = 3;
			var progress = setInterval(function() {
				if (currentBar >= 99) {
					clearInterval(progress);
					progress = null;
				} else {
					if(myNamespace != null){
						currentBar += 1;
						setProgressBar(currentBar);
					}
				}
			}, 700);
			
			// Set up a recurring task to get alternative servers
			var getMyServerListI = setInterval(function() {
				if(myNamespace != null){
					getMyServerList();
					clearInterval(getMyServerListI);
					getMyServerListI = null;
				 }
			},1000);
			setInterval(function() {
				if(myNamespace != null){
					getMyServerList();
				}
			},60*1000);
			
			
			// Get the list of CNodes one time.  This should eventually be fixed to be real-time 
			var getNodeListI = setInterval(function() {
				if(myNamespace != null){
					getMyNodeList();
					clearInterval(getNodeListI);
					getNodeListI = null;
				}
			},100);
				
			var runNodeMonitorCount = 10;
			setInterval(function() {
				if(myNamespace != null){
					runNodeMonitor();
					runNodeMonitorCount++;
					if(runNodeMonitorCount >= 10){
						updateHealthChart();
						runNodeMonitorCount = 0;
					}
				}
			},1000);
			
		});
	</script>

  </body>
</html>

